<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VRKeyboard</title>
    <link rel="stylesheet" type="text/css" href="../css/main.css"/>
    <script src="../libs/three.min.js"></script>
    <script src="../libs/tween.min.js"></script>
    <script src="../js/threejs/renderers/CSS3DRenderer.js"></script>
    <script src="../js/threejs/controls/OrbitControls.js"></script>
    <script src="../js/threejs/controls/TrackballControls.js"></script>
    <script src="../js/VRKeyboard.js"></script>

    <script>
        var container;
        var camera;

        var sceneGl, rendererGl;
        var sceneCss, rendererCss;
        var controls;
        var vrKeyboard;
        var searchTxt;


        var albums=[];
        var floor;
        var holder;
        var itemsToLoad=albums.length;


        function init(element)
        {
            container= document.getElementById(element);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 20000);

            sceneGl = new THREE.Scene();
            sceneCss = new THREE.Scene();

            rendererCss = new THREE.CSS3DRenderer();
            rendererCss.setSize(window.innerWidth, window.innerHeight);
            rendererCss.domElement.style.position = 'absolute';
            rendererCss.domElement.style.top = 0;


            rendererGl = new THREE.WebGLRenderer({alpha:true});
            rendererGl.setClearColor(0x00ff00, 0.0);
            rendererGl.setSize(window.innerWidth, window.innerHeight);

            rendererGl.domElement.style.position = 'absolute';
            rendererGl.domElement.style.zIndex = 1;
            rendererGl.domElement.style.top = 0;
            rendererGl.domElement.style.pointerEvents = 'none';
            rendererGl.shadowMap.enabled=true;
            rendererGl.shadowMap.type = THREE.PCFSoftShadowMap;
            rendererGl.gammaInput = true;
            rendererGl.gammaOutput = true;
            rendererCss.domElement.appendChild(rendererGl.domElement);

            container.appendChild(rendererCss.domElement);


            //controls = new THREE.TrackballControls(camera);
            controls = new THREE.TrackballControls(camera, rendererCss.domElement);
            //controls.maxPolarAngle = Math.PI * 0.5;
            //controls.minPolarAngle = Math.PI * 0.5;
            controls.minDistance = 100;
            controls.maxDistance = 5000;


            //
            camera.position.set(0, 1000, 1500);
            camera.lookAt(new THREE.Vector3(0,0,0))

            window.addEventListener('resize', onWindowResize, false);
            animate();

            //Keyboard
            vrKeyboard=new VRKeyboard()
            vrKeyboard.addEventListener('keypress' , function(e){
                console.log(e.code);
                if(e.code=='\u23CE')
                    doSearch()
            })

            vrKeyboard.rotation.x-=0.9;
            vrKeyboard.position.z+=200;
            //vrKeyboard.position.y-=200
            sceneCss.add(vrKeyboard);


            //keyboard mask
            var bgGeo=new THREE.PlaneGeometry(830,320, 32)
            var bgMat=new THREE.MeshPhongMaterial({color:0x000000});
            bgMat.blending=THREE.NoBlending;
            bgMat.opacity = 0.0;
            bgMat.transparent=true;
            var bg=new THREE.Mesh(bgGeo, bgMat);
            bg.rotation.x-=0.9;
            bg.position.z+=200;
            bg.castShadow = true;
            bg.receiveShadow = true;
            sceneGl.add(bg)

            searchTxt=new VRTextInput('search');
            searchTxt.position.set(0,140-18,0);
            searchTxt.setWidth(800);
            searchTxt.setPlaceholder('Search...')
            sceneCss.add(searchTxt);
            vrKeyboard.register(searchTxt)

            //searchTxt mask
            var txtGeo=new THREE.PlaneGeometry(840,60, 32);
            var txtMat=new THREE.MeshBasicMaterial({color:0x000000});
            txtMat.blending=THREE.NoBlending;
            txtMat.opacity = 0.0;
            txtMat.transparent=true;
            var txt=new THREE.Mesh(txtGeo, txtMat)
            txt.position.set(0,140,0);
            sceneGl.add(txt)


            holder=new THREE.Group();
            sceneGl.add(holder);

            var floorGeo=new THREE.PlaneGeometry(5000,5000, 32 );
            var floorMat=new THREE.MeshPhongMaterial( {color: 0x333333} );
            //floorMat.blending=THREE.NoBlending;
            //floorMat.opacity = 0.0;
            //floorMat.transparent=true;
            floor=new THREE.Mesh( floorGeo, floorMat );
            floor.rotation.x=-Math.PI*.5;
            floor.position.y-=200
            floor.castShadow = true;
            floor.receiveShadow = true;
            sceneGl.add(floor);


            var spotLight = new THREE.SpotLight( 0xffffff, 5.0 );
            spotLight.position.set( 0, 4000, 0 );

            spotLight.castShadow = true;

            spotLight.shadow.mapSize.width = 1024;
            spotLight.shadow.mapSize.height = 1024;

            spotLight.angle = 1;
            spotLight.penumbra = 0.1;
            spotLight.decay = 2;
            spotLight.distance = 6000;



            var ambient = new THREE.AmbientLight( 0x111111 );


            sceneGl.add( spotLight );
            sceneGl.add( ambient );

        }

        function onWindowResize()
        {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            rendererGl.setSize(window.innerWidth, window.innerHeight);
            rendererCss.setSize(window.innerWidth, window.innerHeight);
        }

        function animate()
        {
            requestAnimationFrame(animate);
            controls.update();
            TWEEN.update();
            rendererGl.render(sceneGl, camera);
            rendererCss.render(sceneCss, camera);

        }


        function clear()
        {
            searchTxt.setValue("");
            for (var i = holder.children.length - 1; i >= 0; i--) {
                holder.remove(holder.children[i]);
            }
        }

        function display(albums)
        {
            TWEEN.removeAll();
            var centerX = 0;
            var centerZ = 0;
            var radius = 1200;
            var numberOfPoints = 10;
            var numberOfItems = albums.length;

            for (var i = 0; i < numberOfItems  ; i++) {
                placePlane(radius, i, numberOfPoints, numberOfItems);
            }
        }

        function placePlane(radius, currentPoint, numberOfPoints, numberOfItems)
        {

            var theta = ((Math.PI) / numberOfPoints);
            var angle = (-theta * (currentPoint % numberOfPoints));
            var posY=350*(Math.floor((currentPoint)/numberOfPoints)) //grid
            var posX=Math.round(radius * Math.cos(angle));
            var posZ=Math.round(radius * Math.sin(angle));

            var endPos=new THREE.Vector3(posX, posY, posZ);

            var geometry = new THREE.CubeGeometry( 300, 300, 10 );

            var materials=[
                new THREE.MeshPhongMaterial( { color: 0x666666} ), // right
                new THREE.MeshPhongMaterial( { color: 0x666666} ), // left
                new THREE.MeshPhongMaterial( { color: 0x666666} ), // top
                new THREE.MeshPhongMaterial( { color: 0x666666} ), // bottom
                new THREE.MeshPhongMaterial( { map:albums[currentPoint].texture } ), // back
                new THREE.MeshPhongMaterial( { color: 0x333333} )  // front
            ]

            var material = new THREE.MultiMaterial( materials );
            material.map=albums[currentPoint].texture;
            //material.blending=THREE.NoBlending
            //material.opacity = 0.0;
            //material.transparent=true;
            material.needsUpdate=true;

            var plane = new THREE.Mesh( geometry, material );
            plane.position.set(endPos.x, endPos.y, endPos.z)
            plane.lookAt(new THREE.Vector3(0,posY,0))//todo check Y pos
            plane.castShadow=true;
            plane.receiveShadow=true;
            plane.scale.set(0, 0, 0)
            holder.add( plane );

            new TWEEN.Tween( plane.scale )
                    .to( { x: 1, y: 1, z:1 }, 1000 )
                    .easing( TWEEN.Easing.Exponential.InOut )//.delay(50*currentPoint)
                    .start();
        }



        function doSearch(keywords)
        {
            var apiURL = "https://api.spotify.com/v1/search?q="+searchTxt.getValue()+"&type=album&limit=50";
            clear()
            getJSON(apiURL, function(data) {
                albums=[]
                for(var i in data.albums.items)
                {
                    var album = {name:data.albums.items[i].name, thumb:data.albums.items[i].images[0].url};
                    albums.push(album);
                }
                loadAlbums(albums)
            });
        }


        function loadAlbums(albums)
        {
            itemsToLoad=albums.length;
            for(var i in albums)
            {
                albums[i].loadCover=function()
                {
                    var self=this;
                    this.loader=new THREE.TextureLoader();
                    this.loader.crossOrigin="anonymous";
                    this.loader.load(this.thumb,
                        function (data)
                        {
                            self.texture=data;
                            itemsToLoad--
                            if(itemsToLoad==0)
                                display(albums);
                        },   // Function called when download progresses
                        function (xhr)
                        {

                        },
                        // Function called when download errors
                        function (xhr)
                        {

                        }
                    )
                }
                albums[i].loadCover();
            }
        }

        function getJSON(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var res = xhr.responseText;
                        callback(JSON.parse(res));
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.onerror = function (e) {
                console.error(xhr.statusText);
            };
            xhr.send(null);
        }


    </script>

</head>
<body onload="init('container')">
    <div id="msg">Find Artists or Albums on Spotify: Type search keywords and click ENTER</div>
    <div id="container"></div>
</body>
</html>